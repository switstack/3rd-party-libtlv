name: build

on:
  workflow_call:

jobs:

  build:

    strategy:
      matrix:
        configuration:
          - os: ubuntu-22.04
            compiler:
              c: gcc-11
              cxx: g++-11
              c_cxx_flags: --std=c++11 -Werror -Wall -Wextra -pedantic -pedantic-errors
            packages: gcc-11 g++-11 cpputest
          
          - os: ubuntu-22.04
            compiler:
              c: clang-14
              cxx: clang++-14
              c_cxx_flags: --std=c++11 -Werror -Wall -Wextra -pedantic -pedantic-errors
            packages: clang-14 cpputest
          
          - os: macos-13
            compiler:
              c: clang
              cxx: clang++
              c_cxx_flags: --std=c++11 -Werror -Wall -Wextra -pedantic -pedantic-errors
            packages: cpputest
          
          - os: windows-2019
            compiler:
              c: ~
              cxx: ~
              c_cxx_flags: ~
            packages: ~

    runs-on: ${{ matrix.configuration.os }}

    env:
      BUILD_DIRECTORY: ./build
      SOURCE_DIRECTORY: .

    steps:
  
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up build environment
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == 'Linux' ]]; then
            distribution=$(cat /etc/*-release | grep ID | awk 'FNR <= 1' | cut -d '=' -f2 | tr '[:upper:]' '[:lower:]')
            if [[ "$distribution" == 'debian' || "$distribution" == 'ubuntu' ]]; then
              sudo apt update
              sudo apt install -y \
                ${{ matrix.configuration.packages }}
            else
              echo "Linux distribution '$distribution' not supported"
              exit 1
            fi
          elif [[ "$RUNNER_OS" == 'macOS' ]]; then
            brew install \
              ${{ matrix.configuration.packages }}
          fi

      - name: Configure
        shell: bash
        run: |
          cmake \
            -B "${{ env.BUILD_DIRECTORY }}" \
            -S "${{ env.SOURCE_DIRECTORY }}" \
            -D CMAKE_C_COMPILER="${{ matrix.configuration.compiler.c }}" \
            -D CMAKE_C_FLAGS="${{ matrix.configuration.compiler.c_cxx_flags }}" \
            -D CMAKE_CXX_COMPILER="${{ matrix.configuration.compiler.cxx }}" \
            -D CMAKE_CXX_FLAGS="${{ matrix.configuration.compiler.c_cxx_flags }}" \
            -D CMAKE_BUILD_TYPE="Release" \
            -D TLV_BUILD_TESTS="${{ runner.os == 'Linux' && 'ON' || 'OFF'  }}"

      - name: Build
        shell: bash
        run: |
          cmake \
            --build \
            "${{ env.BUILD_DIRECTORY }}"

      - name: Test
        if: runner.os == 'Linux'
        shell: bash
        run: |
          ctest \
            --test-dir \
            "${{ env.BUILD_DIRECTORY }}" \
            --no-tests=error
